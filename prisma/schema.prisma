generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Company {
  id                 String             @id @default(cuid())
  name               String
  email              String?
  phone              String?
  address            String?
  city               String?
  state              String?
  zip                String?
  logo               String?
  taxId              String?
  timezone           String?            @default("America/New_York")
  stripeAccountId    String?
  stripePricingModel String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  attachments        Attachment[]
  customers          Customer[]
  estimates          Estimate[]
  invoices           Invoice[]
  jobs               Job[]
  leads              Lead[]
  payments           Payment[]
  recurringInvoices  RecurringInvoice[]
  transactions       Transaction[]
  users              User[]
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String?
  role          String    @default("owner")
  companyId     String
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  accounts      Account[]
  assignedJobs  Job[]     @relation("AssignedJobs")
  sessions      Session[]
  company       Company   @relation(fields: [companyId], references: [id])
}

model Customer {
  id                 String             @id @default(cuid())
  companyId          String
  firstName          String
  lastName           String?
  email              String?
  phone              String?
  address            String?
  city               String?
  state              String?
  zip                String?
  notes              String?
  tags               String[]
  portalToken        String?            @unique
  portalTokenExpires DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  company            Company            @relation(fields: [companyId], references: [id])
  estimates          Estimate[]
  invoices           Invoice[]
  jobs               Job[]
  recurringInvoices  RecurringInvoice[]
}

model Estimate {
  id             String             @id @default(cuid())
  estimateNumber String             @unique
  companyId      String
  customerId     String
  status         String             @default("draft")
  title          String
  description    String?
  subtotal       Float              @default(0)
  tax            Float              @default(0)
  taxRate        Float              @default(0)
  total          Float              @default(0)
  validUntil     DateTime?
  notes          String?
  viewedAt       DateTime?
  approvedAt     DateTime?
  rejectedAt     DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  attachments    Attachment[]
  company        Company            @relation(fields: [companyId], references: [id])
  customer       Customer           @relation(fields: [customerId], references: [id])
  lineItems      EstimateLineItem[]
  invoices       Invoice[]
}

model EstimateLineItem {
  id          String   @id @default(cuid())
  estimateId  String
  description String
  quantity    Float    @default(1)
  rate        Float
  amount      Float
  type        String   @default("service")
  createdAt   DateTime @default(now())
  estimate    Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
}

model Invoice {
  id                 String            @id @default(cuid())
  invoiceNumber      String            @unique
  companyId          String
  customerId         String
  jobId              String?
  status             String            @default("draft")
  subtotal           Float             @default(0)
  tax                Float             @default(0)
  taxRate            Float             @default(0)
  total              Float             @default(0)
  amountPaid         Float             @default(0)
  amountDue          Float             @default(0)
  dueDate            DateTime?
  paidDate           DateTime?
  viewedAt           DateTime?
  notes              String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  estimateId         String?
  recurringInvoiceId String?
  attachments        Attachment[]
  company            Company           @relation(fields: [companyId], references: [id])
  customer           Customer          @relation(fields: [customerId], references: [id])
  estimate           Estimate?         @relation(fields: [estimateId], references: [id])
  job                Job?              @relation(fields: [jobId], references: [id])
  recurringInvoice   RecurringInvoice? @relation(fields: [recurringInvoiceId], references: [id])
  lineItems          InvoiceLineItem[]
  payments           Payment[]
}

model InvoiceLineItem {
  id          String   @id @default(cuid())
  invoiceId   String
  description String
  quantity    Float    @default(1)
  rate        Float
  amount      Float
  type        String   @default("service")
  createdAt   DateTime @default(now())
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model Payment {
  id              String    @id @default(cuid())
  companyId       String
  invoiceId       String
  amount          Float
  method          String
  status          String    @default("pending")
  stripePaymentId String?
  paidAt          DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  company         Company   @relation(fields: [companyId], references: [id])
  invoice         Invoice   @relation(fields: [invoiceId], references: [id])
}

model Job {
  id               String       @id @default(cuid())
  companyId        String
  customerId       String
  title            String
  description      String?
  status           String       @default("scheduled")
  scheduledAt      DateTime?
  completedAt      DateTime?
  address          String?
  city             String?
  state            String?
  zip              String?
  notes            String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  assignedToUserId String?
  attachments      Attachment[]
  invoices         Invoice[]
  assignedTo       User?        @relation("AssignedJobs", fields: [assignedToUserId], references: [id])
  company          Company      @relation(fields: [companyId], references: [id])
  customer         Customer     @relation(fields: [customerId], references: [id])
}

model Lead {
  id        String   @id @default(cuid())
  companyId String
  firstName String
  lastName  String?
  email     String?
  phone     String?
  source    String?
  status    String   @default("new")
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  company   Company  @relation(fields: [companyId], references: [id])
}

model Transaction {
  id          String   @id @default(cuid())
  companyId   String
  type        String
  category    String
  amount      Float
  description String?
  date        DateTime @default(now())
  invoiceId   String?
  createdAt   DateTime @default(now())
  company     Company  @relation(fields: [companyId], references: [id])
}

model RecurringInvoice {
  id          String    @id @default(cuid())
  companyId   String
  customerId  String
  template    Json
  frequency   String
  startDate   DateTime
  endDate     DateTime?
  nextRunDate DateTime
  isActive    Boolean   @default(true)
  lastRunDate DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  invoices    Invoice[]
  company     Company   @relation(fields: [companyId], references: [id])
  customer    Customer  @relation(fields: [customerId], references: [id])
}

model Attachment {
  id         String    @id @default(cuid())
  companyId  String
  fileName   String
  fileUrl    String
  fileSize   Int
  mimeType   String
  estimateId String?
  invoiceId  String?
  jobId      String?
  createdAt  DateTime  @default(now())
  createdBy  String?
  company    Company   @relation(fields: [companyId], references: [id])
  estimate   Estimate? @relation(fields: [estimateId], references: [id])
  invoice    Invoice?  @relation(fields: [invoiceId], references: [id])
  job        Job?      @relation(fields: [jobId], references: [id])
}
